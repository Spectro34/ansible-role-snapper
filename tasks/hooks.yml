---
# Pre/post snapshot hooks management

- name: Check if configuration exists before configuring hooks
  ansible.builtin.command:
    cmd: "snapper -c {{ item.config }} get-config"
  changed_when: false
  failed_when: false
  check_mode: false
  register: config_exists_for_hooks
  loop: "{{ snapper_hooks | default([]) }}"
  loop_control:
    label: "{{ item.config }}"
  when: snapper_hooks is defined and snapper_hooks | length > 0
  tags:
    - snapper
    - snapper_hooks

- name: Configure pre-snapshot hooks
  ansible.builtin.lineinfile:
    path: "/etc/snapper/configs/{{ item.config }}"
    regexp: '^PRE_SNAPSHOT_SCRIPT='
    line: 'PRE_SNAPSHOT_SCRIPT="{{ item.script }}"'
    state: "{{ item.state | default('present') }}"
    backup: true
  loop: "{{ snapper_hooks | selectattr('type', 'equalto', 'pre') | list }}"
  loop_control:
    label: "{{ item.config }}:{{ item.script }}"
  when:
    - snapper_hooks is defined and snapper_hooks | length > 0
    - config_exists_for_hooks.rc == 0
  tags:
    - snapper
    - snapper_hooks

- name: Configure post-snapshot hooks
  ansible.builtin.lineinfile:
    path: "/etc/snapper/configs/{{ item.config }}"
    regexp: '^POST_SNAPSHOT_SCRIPT='
    line: 'POST_SNAPSHOT_SCRIPT="{{ item.script }}"'
    state: "{{ item.state | default('present') }}"
    backup: true
  loop: "{{ snapper_hooks | selectattr('type', 'equalto', 'post') | list }}"
  loop_control:
    label: "{{ item.config }}:{{ item.script }}"
  when:
    - snapper_hooks is defined and snapper_hooks | length > 0
    - config_exists_for_hooks.rc == 0
  tags:
    - snapper
    - snapper_hooks
